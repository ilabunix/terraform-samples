version: 0.2

phases:
  install:
    commands:
      - echo "Installing Packer"
      - cp tools/packer/packer /usr/local/bin/packer
      - chmod +x /usr/local/bin/packer
      - packer --version
      
  pre_build:
    commands:
      - echo "=== Starting Silver AMI Authoring Build ==="
      - export BASE_AMI_NAME=$(cat nit_base_ami_name.txt)
      - echo "Base AMI Name = $BASE_AMI_NAME"
      - export BASE_AMI_OWNER="$BASE_AMI_OWNER_ID"
      - echo "Base AMI Owner = $BASE_AMI_OWNER"
      
  build:
    commands:
      - echo "Packer build started for BloomReach Authoring Silver AMI"
      - packer build -debug ./packer/bloomreach_silver_authoring_ami.json
      - ls -l
      
      # Extract AMI ID from manifest
      - |
        if [ -f silver_authoring_manifest.json ]; then
          awk 'match($0, /ami-[a-z0-9]+/) {print substr($0, RSTART, RLENGTH)}' silver_authoring_manifest.json | awk 'sub("$", "")' > silver_authoring_ami_id.txt
          export SILVER_AUTH_AMI_ID=$(cat silver_authoring_ami_id.txt)
          echo "âœ… Silver Authoring AMI ID = $SILVER_AUTH_AMI_ID"
        else
          echo "ERROR: Manifest file not found!"
          exit 1
        fi
      
artifacts:
  files:
    - silver_authoring_manifest.json
    - silver_authoring_ami_id.txt
