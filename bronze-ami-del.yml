version: 0.2

phases:
  install:
    commands:
      - echo "Installing Packer"
      - cp tools/packer/packer /usr/local/bin/packer
      - chmod +x /usr/local/bin/packer
      - packer --version
      
  pre_build:
    commands:
      - echo "=== Starting Bronze AMI Delivery Build ==="
      
      # Read Silver AMI ID from artifact
      - ls -la
      - |
        if [ -f silver_delivery_ami_id.txt ]; then
          export silver_ami_del=$(cat silver_delivery_ami_id.txt)
          echo "✅ Using Silver Delivery AMI = $silver_ami_del"
        else
          echo "ERROR: silver_delivery_ami_id.txt not found!"
          exit 1
        fi
      
      - export BASE_AMI_OWNER="$BASE_AMI_OWNER_ID"
      - echo "Base AMI Owner = $BASE_AMI_OWNER"
      
  build:
    commands:
      - echo "Packer build started for BloomReach Delivery Bronze AMI"
      - echo "SILVER_DEL_AMI_ID=$silver_ami_del"
      - packer build -debug ./packer/bloomreach_bronze_delivery_ami.json
      - ls -l
      
      # Extract Bronze AMI ID
      - |
        if [ -f bronze_delivery_manifest.json ]; then
          awk 'match($0, /ami-[a-z0-9]+/) {print substr($0, RSTART, RLENGTH)}' bronze_delivery_manifest.json | awk 'sub("$", "")' > bronze_delivery_ami_id.txt
          export BRONZE_DEL_AMI_ID=$(cat bronze_delivery_ami_id.txt)
          echo "✅ Bronze Delivery AMI ID = $BRONZE_DEL_AMI_ID"
        else
          echo "ERROR: Manifest file not found!"
          exit 1
        fi
      
artifacts:
  files:
    - bronze_delivery_manifest.json
    - bronze_delivery_ami_id.txt
