version: 0.2

env:
  variables:
    TEST_ACCOUNT: "175809624659"
    QA_ACCOUNT: "762649877014"
    PROD_ACCOUNT: "609253628652"
    REGION: "us-east-2"
    S3_BUCKET: "awc-n-fi-development-bloomreach-ami-refresh"

phases:
  pre_build:
    commands:
      - echo "=== Starting AMI Sharing Process ==="
      - echo "Listing available files..."
      - ls -ltr
      
      # Read Bronze AMI IDs
      - |
        if [ -f bronze_authoring_ami_id.txt ] && [ -f bronze_delivery_ami_id.txt ]; then
          export BRONZE_AUTH_AMI_ID=$(cat bronze_authoring_ami_id.txt)
          export BRONZE_DEL_AMI_ID=$(cat bronze_delivery_ami_id.txt)
          echo "✅ Bronze Authoring AMI = $BRONZE_AUTH_AMI_ID"
          echo "✅ Bronze Delivery AMI = $BRONZE_DEL_AMI_ID"
        else
          echo "ERROR: Bronze AMI ID files not found!"
          exit 1
        fi
      
  build:
    commands:
      - echo "=== Uploading Manifest Files to S3 ==="
      - aws s3 cp silver_authoring_manifest.json s3://${S3_BUCKET}/manifest/
      - aws s3 cp silver_delivery_manifest.json s3://${S3_BUCKET}/manifest/
      - aws s3 cp bronze_authoring_manifest.json s3://${S3_BUCKET}/manifest/
      - aws s3 cp bronze_delivery_manifest.json s3://${S3_BUCKET}/manifest/
      - echo "✅ Manifests uploaded to S3"
      
      - echo "=== Sharing Bronze Authoring AMI ==="
      - echo "Updating new AMI info"
      - aws s3 cp bronze_authoring_ami_id.txt s3://${S3_BUCKET}/ami-list/
      - aws s3 cp bronze_delivery_ami_id.txt s3://${S3_BUCKET}/ami-list/
      
      # Get snapshot IDs for Bronze Authoring AMI
      - |
        SNAP_ID_AUTH=$(aws ec2 describe-images \
          --image-ids $BRONZE_AUTH_AMI_ID \
          --region $REGION \
          --query 'Images[0].BlockDeviceMappings[*].Ebs.SnapshotId' \
          --output text)
        
        echo "Bronze Authoring Snapshot IDs: $SNAP_ID_AUTH"
        
        # Modify snapshot attributes
        for snap in $SNAP_ID_AUTH; do
          echo "Sharing snapshot $snap..."
          aws ec2 modify-snapshot-attribute \
            --snapshot-id $snap \
            --attribute createVolumePermission \
            --operation-type add \
            --user-ids $TEST_ACCOUNT $QA_ACCOUNT $PROD_ACCOUNT \
            --region $REGION
        done
      
      # Modify AMI launch permissions for Bronze Authoring
      - |
        echo "Sharing Bronze Authoring AMI $BRONZE_AUTH_AMI_ID..."
        aws ec2 modify-image-attribute \
          --image-id $BRONZE_AUTH_AMI_ID \
          --launch-permission "Add=[{UserId=$TEST_ACCOUNT},{UserId=$QA_ACCOUNT},{UserId=$PROD_ACCOUNT}]" \
          --region $REGION
      
      - echo "=== Sharing Bronze Delivery AMI ==="
      
      # Get snapshot IDs for Bronze Delivery AMI
      - |
        SNAP_ID_DEL=$(aws ec2 describe-images \
          --image-ids $BRONZE_DEL_AMI_ID \
          --region $REGION \
          --query 'Images[0].BlockDeviceMappings[*].Ebs.SnapshotId' \
          --output text)
        
        echo "Bronze Delivery Snapshot IDs: $SNAP_ID_DEL"
        
        # Modify snapshot attributes
        for snap in $SNAP_ID_DEL; do
          echo "Sharing snapshot $snap..."
          aws ec2 modify-snapshot-attribute \
            --snapshot-id $snap \
            --attribute createVolumePermission \
            --operation-type add \
            --user-ids $TEST_ACCOUNT $QA_ACCOUNT $PROD_ACCOUNT \
            --region $REGION
        done
      
      # Modify AMI launch permissions for Bronze Delivery
      - |
        echo "Sharing Bronze Delivery AMI $BRONZE_DEL_AMI_ID..."
        aws ec2 modify-image-attribute \
          --image-id $BRONZE_DEL_AMI_ID \
          --launch-permission "Add=[{UserId=$TEST_ACCOUNT},{UserId=$QA_ACCOUNT},{UserId=$PROD_ACCOUNT}]" \
          --region $REGION
      
      - echo "✅ New BloomReach AMIs and EBS Volume Snapshots have been shared to TEST, QA and PROD AWS Accounts"
      
  post_build:
    commands:
      - echo "=== AMI Sharing Complete ==="
      - echo "Bronze Authoring AMI: $BRONZE_AUTH_AMI_ID (shared)"
      - echo "Bronze Delivery AMI: $BRONZE_DEL_AMI_ID (shared)"
